{% extends "static_site/_base.html" %}
{% block page_title %}{{ topic.title }} - GOV.UK Ethnicity facts and figures{% endblock %}
{% block meta_title %}{{ topic.title }}{% endblock %}

{% block google_analytics %}ga('set','contentGroup1','Topic'){% endblock %}
{% block main_content %}

<main id="content">
	{%  include 'static_site/_phase_banner.html' %}
	<div class="breadcrumbs">
		<ol>
			<li> <a href="/">Ethnicity facts and figures</a></li>
		</ol>
	</div>

	<div class="grid-row">
		<div class="column-two-thirds">
			<h1 class="heading-xlarge">
				{{ topic.title }}
			</h1>
            {% if topic.additional_description  %}
                <p>
                    {{ topic.additional_description | render_markdown  }}
                </p>
            {% endif %}
		</div>
	</div>

	<div class="grid-row">

        {% if static_mode %}
            <div class="column-two-thirds">
        {% else %}
            <div class="column-full">
        {% endif %}

            <div class="accordion">
            <div class="container">
                {% for subtopic in subtopics %}

                    {% if measures[subtopic.guid] %}
                            <div class="accordion-section">
                                <div class="accordion-section-header" data-on="click" data-event-category="Accordion" data-event-action="Section opened" data-event-label="{{ subtopic.title }}" >
                                    <h2 class="heading-medium">
                                        {{ subtopic.title }}
                                    </h2>
                                </div>
                                <div class="accordion-section-body">
                                    {% if static_mode %}
                                        <ul class="links">
                                            {% for m in measures[subtopic.guid] %}
                                                <li>
                                                    <a href="{{ url_for('static_site.measure_page',
                                                                        topic=topic.uri,
                                                                        subtopic=subtopic.uri,
                                                                        measure=m.uri,
                                                                        version='latest') }}">{{ m.title }}
                                                    </a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        {% include 'cms/_measures_with_version_history.html' %}
                                         <p><a href="{{ url_for('cms.create_measure_page', topic=topic.guid, subtopic=subtopic.guid) }}" class="button">Add a
        measure to {{ subtopic.title }}</a>
      </p>
                                    {% endif %}
                                </div>
                            </div>
                    {% endif %}
                {% endfor %}
			</div>
		</div>
	</div>
</div>
</main>

{% endblock %}


{% block body_end_more %}

    <script type="text/javascript">

        var orderMeasures = function(tbody) {

            var status = tbody.parentElement.previousElementSibling;
            var savingIntervalId;

            var stillSaving = function () {
                switch (status.textContent) {
                    case 'Saving new order':
                        status.textContent = 'Saving new order.';
                        break;
                    case 'Saving new order.':
                        status.textContent = 'Saving new order..';
                        break;
                    case 'Saving new order..':
                        status.textContent = 'Saving new order...';
                        break;
                    case 'Saving new order...':
                        status.textContent = 'Saving new order';
                        break;
                }
            };

            var saved = function (savingIntervalId) {
                clearInterval(savingIntervalId);
                status.textContent = 'Saved';
                status.classList.add('status-invisible');
            };

            var positions = [];
            for(var i = 0; i < tbody.rows.length; i++) {
                 positions.push({"position": i,
                                 "guid": tbody.rows[i].dataset.guid,
                                 "subtopic": tbody.rows[i].dataset.subtopic})
            }

            status.classList.remove('status-invisible');
            status.textContent = 'Saving new order';
            savingIntervalId = setInterval(stillSaving, 300);

            $.ajax({
                type: 'POST',
                url: "{{ url_for('cms.set_measure_order') }}",
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({"positions": positions}),
                success: function (data) {
                    console.log('Set order for measures:', positions);
                    saved(savingIntervalId);
                },
                error: function (data) {
                    console.log('Error setting order for measures:', positions);
                }
            });
        };

        var tableBodies = document.querySelectorAll('tbody');
        tableBodies.forEach(function (tbody) {
            if (tbody.rows.length > 1) {
                var r = new ReorderableRows(tbody);
                r.onDrop = orderMeasures;
            }
        })

    </script>

{% endblock %}